<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Audio Upload</title>
</head>
<body>
    <input type="file" id="audio-file-input" accept="audio/*">
    <button id="upload-button" disabled>Upload and Play</button>
    <button id="record-button">Record</button>
    <button id="stop-button" disabled>Stop</button>
    <audio id="audio-player" controls></audio>

    <!-- Подключаем конфигурацию Firebase и скрипты -->
    <script type="module" src="firebaseConfig.js"></script>
    <script type="module">
        import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-database.js";
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import firebaseConfig from './firebaseConfig.js';
        import { AudioRecorder } from './audioRecorder.js';

        // Инициализируем Firebase и базу данных
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // Инициализируем AudioRecorder
        const audioRecorder = new AudioRecorder('audio-player', 'record-button', 'stop-button', 'upload-button', 'audio-file-input');

        // Проверяем наличие сохраненного аудиофайла при загрузке страницы
        document.addEventListener('DOMContentLoaded', async () => {
            const savedAudioUrl = await checkAndGetAudioUrl('saved_audio');
            if (savedAudioUrl) {
                audioRecorder.audioPlayer.src = savedAudioUrl;
                // Убираем автоплей
                // audioRecorder.audioPlayer.play().catch(error => {
                //     if (error.name === 'NotAllowedError') {
                //         alert('Пожалуйста, взаимодействуйте с документом перед воспроизведением аудиофайла.');
                //     } else {
                //         console.error('Ошибка воспроизведения аудиофайла:', error);
                //     }
                // });
            }
        });

        async function checkAndGetAudioUrl(fileName) {
            try {
                const audioRef = ref(db, `audio/${sanitizeFileName(fileName)}`);
                const snapshot = await get(audioRef);
                if (snapshot.exists()) {
                    const base64String = snapshot.val();
                    const audioUrl = `data:audio/webm;base64,${base64String}`;
                    console.log('Аудиофайл найден в Firebase Database:', audioUrl);
                    return audioUrl;
                } else {
                    console.log('Аудиофайл не найден в Firebase Database');
                    return null;
                }
            } catch (error) {
                console.error('Ошибка проверки аудиофайла в Firebase Database:', error);
                return null;
            }
        }

        function sanitizeFileName(fileName) {
            return fileName.replace(/[.#$[\]]/g, '_');
        }
    </script>
</body>
</html>
